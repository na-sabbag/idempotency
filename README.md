# API de Idempot√™ncia - Demonstra√ß√£o Educacional

Esta API demonstra **6 padr√µes diferentes de idempot√™ncia** implementados em ASP.NET Core 8.0 para fins educacionais.

## üìö O que √© Idempot√™ncia?

Uma opera√ß√£o √© **idempotente** quando pode ser executada m√∫ltiplas vezes sem alterar o resultado al√©m da primeira aplica√ß√£o.

**Exemplo do Mundo Real:** Ligar um interruptor de luz que j√° est√° ligado n√£o muda nada - a luz continua acesa.

### Por que Idempot√™ncia √© Importante?

- ‚úÖ **Retry seguro**: Pode retentar opera√ß√µes sem efeitos colaterais
- ‚úÖ **Resili√™ncia**: Protege contra falhas de rede e timeouts
- ‚úÖ **Mensageria**: Previne processamento duplicado de mensagens
- ‚úÖ **Distributed Systems**: Essencial em sistemas distribu√≠dos

---

## üöÄ Como Executar

```bash
# Restaurar depend√™ncias
dotnet restore

# Executar a API
dotnet run

# Ou usar o comando watch para desenvolvimento
dotnet watch run
```

A API estar√° dispon√≠vel em:
- **HTTP**: http://localhost:5000
- **HTTPS**: https://localhost:5001
- **Swagger**: https://localhost:5001/swagger

---

## üìã Padr√µes Implementados

### 1Ô∏è‚É£ Chave de Idempot√™ncia (Idempotency Key)

**Conceito**: Cliente gera um identificador √∫nico e o envia com a requisi√ß√£o. Servidor armazena e verifica a chave antes de processar.

**Endpoints:**
- `POST /api/idempotencykey/order` - Criar pedido
- `POST /api/idempotencykey/payment` - Processar pagamento

**Como Testar:**

```bash
# Primeira requisi√ß√£o - ser√° processada
curl -X POST https://localhost:5001/api/idempotencykey/order \
  -H "Content-Type: application/json" \
  -d '{
    "idempotencyKey": "minha-chave-unica-123",
    "data": "Pedido de exemplo"
  }'

# Segunda requisi√ß√£o com MESMA chave - retorna resultado em cache
curl -X POST https://localhost:5001/api/idempotencykey/order \
  -H "Content-Type: application/json" \
  -d '{
    "idempotencyKey": "minha-chave-unica-123",
    "data": "Pedido de exemplo"
  }'
```

**Resultado Esperado:**
- Primeira chamada: `isFromCache: false` (processado)
- Segunda chamada: `isFromCache: true` (retornado do cache)

**Quando Usar:**
- ‚úÖ APIs de pagamento
- ‚úÖ Cria√ß√£o de recursos cr√≠ticos
- ‚úÖ Opera√ß√µes que n√£o devem ser duplicadas

---

### 2Ô∏è‚É£ Idempot√™ncia Natural

**Conceito**: Algumas opera√ß√µes HTTP s√£o naturalmente idempotentes (PUT, DELETE).

**Endpoints:**
- `GET /api/naturalidempotency/profiles` - Listar perfis
- `GET /api/naturalidempotency/profiles/{userId}` - Obter perfil
- `PUT /api/naturalidempotency/profiles/{userId}` - Atualizar perfil (IDEMPOTENTE)
- `DELETE /api/naturalidempotency/profiles/{userId}` - Deletar perfil (IDEMPOTENTE)
- `POST /api/naturalidempotency/profiles` - Criar perfil (N√ÉO IDEMPOTENTE)

**Como Testar:**

```bash
# PUT √© idempotente - sempre resulta no mesmo estado final
curl -X PUT https://localhost:5001/api/naturalidempotency/profiles/user-1 \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Jo√£o Silva",
    "email": "joao@example.com",
    "bio": "Desenvolvedor"
  }'

# Repetir o PUT - mesmo resultado
curl -X PUT https://localhost:5001/api/naturalidempotency/profiles/user-1 \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Jo√£o Silva",
    "email": "joao@example.com",
    "bio": "Desenvolvedor"
  }'

# DELETE √© idempotente
curl -X DELETE https://localhost:5001/api/naturalidempotency/profiles/user-1

# DELETE novamente - ainda retorna sucesso
curl -X DELETE https://localhost:5001/api/naturalidempotency/profiles/user-1
```

**Quando Usar:**
- ‚úÖ REST APIs seguindo padr√µes
- ‚úÖ Opera√ß√µes baseadas em estado final
- ‚úÖ Substitui√ß√£o completa de recursos

**Diferen√ßa entre m√©todos HTTP:**
- ‚úÖ `GET` - Idempotente (s√≥ l√™)
- ‚úÖ `PUT` - Idempotente (substitui completamente)
- ‚úÖ `DELETE` - Idempotente (deletar algo j√° deletado n√£o muda nada)
- ‚ùå `POST` - N√ÉO Idempotente (cria novo recurso cada vez)

---

### 3Ô∏è‚É£ Idempot√™ncia Version-Based (Optimistic Locking)

**Conceito**: Cada recurso tem um n√∫mero de vers√£o. Opera√ß√µes incluem a vers√£o esperada. Se a vers√£o for diferente, h√° conflito.

**Endpoints:**
- `GET /api/versionbased/resources` - Listar recursos
- `GET /api/versionbased/resources/{id}` - Obter recurso
- `PUT /api/versionbased/resources/{id}` - Atualizar com vers√£o
- `POST /api/versionbased/resources/{id}/simulate-conflict` - Demo de conflito

**Como Testar:**

```bash
# 1. Obter recurso e vers√£o atual
curl https://localhost:5001/api/versionbased/resources/config-1

# Resposta: { "version": 1, ... }

# 2. Atualizar com vers√£o correta - SUCESSO
curl -X PUT https://localhost:5001/api/versionbased/resources/config-1 \
  -H "Content-Type: application/json" \
  -d '{
    "name": "AppTimeout",
    "value": "60",
    "expectedVersion": 1
  }'

# Resposta: { "version": 2, ... } - vers√£o incrementada!

# 3. Tentar atualizar com vers√£o antiga - CONFLITO
curl -X PUT https://localhost:5001/api/versionbased/resources/config-1 \
  -H "Content-Type: application/json" \
  -d '{
    "name": "AppTimeout",
    "value": "90",
    "expectedVersion": 1
  }'

# Resposta: 409 Conflict - vers√£o esperada (1) ‚â† vers√£o atual (2)
```

**Quando Usar:**
- ‚úÖ Optimistic Locking
- ‚úÖ Prevenir "lost updates"
- ‚úÖ Sistemas com m√∫ltiplos clientes editando dados
- ‚úÖ Bancos de dados distribu√≠dos

**Vantagens:**
- N√£o requer locks
- Melhor performance
- Detecta conflitos

---

### 4Ô∏è‚É£ Idempot√™ncia Token-Based

**Conceito**: Servidor gera um token √∫nico que s√≥ pode ser usado uma vez. Similar a CSRF tokens.

**Endpoints:**
- `POST /api/tokenbased/token/generate` - Gerar token
- `POST /api/tokenbased/payment` - Processar pagamento com token
- `POST /api/tokenbased/order` - Criar pedido com token
- `GET /api/tokenbased/demo` - Demonstra√ß√£o

**Como Testar:**

```bash
# 1. Gerar token
TOKEN=$(curl -X POST https://localhost:5001/api/tokenbased/token/generate | jq -r '.token')

echo "Token gerado: $TOKEN"

# 2. Usar token - SUCESSO
curl -X POST https://localhost:5001/api/tokenbased/payment \
  -H "Content-Type: application/json" \
  -d "{
    \"token\": \"$TOKEN\",
    \"amount\": 250.00,
    \"description\": \"Pagamento de teste\"
  }"

# 3. Tentar usar o MESMO token novamente - ERRO
curl -X POST https://localhost:5001/api/tokenbased/payment \
  -H "Content-Type: application/json" \
  -d "{
    \"token\": \"$TOKEN\",
    \"amount\": 250.00,
    \"description\": \"Pagamento de teste\"
  }"

# Resposta: 400 Bad Request - "Token j√° foi utilizado"
```

**Quando Usar:**
- ‚úÖ Formul√°rios de pagamento
- ‚úÖ Preven√ß√£o de dupla submiss√£o
- ‚úÖ Opera√ß√µes sens√≠veis
- ‚úÖ Similar a CSRF protection

**Caracter√≠sticas:**
- Token expira em 15 minutos
- S√≥ pode ser usado uma vez
- Gerado pelo servidor (n√£o pelo cliente)

---

### 5Ô∏è‚É£ Desduplica√ß√£o Timestamp-Based

**Conceito**: Armazena timestamp da √∫ltima opera√ß√£o. Ignora opera√ß√µes com timestamp anterior.

**‚ö†Ô∏è CUIDADO**: Problemas com **Clock Skew** (rel√≥gios desincronizados)!

**Endpoints:**
- `GET /api/timestampbased/operations` - Listar opera√ß√µes
- `GET /api/timestampbased/operations/{resourceId}` - Obter opera√ß√£o
- `POST /api/timestampbased/sensor` - Atualizar sensor
- `POST /api/timestampbased/demo/clock-skew` - Demo de problemas

**Como Testar:**

```bash
# 1. Enviar opera√ß√£o com timestamp atual - ACEITO
curl -X POST https://localhost:5001/api/timestampbased/sensor \
  -H "Content-Type: application/json" \
  -d "{
    \"resourceId\": \"sensor-1\",
    \"value\": \"25.5\",
    \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
  }"

# 2. Enviar opera√ß√£o com timestamp antigo - REJEITADO
curl -X POST https://localhost:5001/api/timestampbased/sensor \
  -H "Content-Type: application/json" \
  -d "{
    \"resourceId\": \"sensor-1\",
    \"value\": \"26.0\",
    \"timestamp\": \"2024-01-01T00:00:00Z\"
  }"

# Resposta: 409 Conflict - timestamp anterior ao √∫ltimo processado
```

**Quando Usar:**
- ‚úÖ Dados de sensores IoT
- ‚úÖ Sistemas de telemetria
- ‚ö†Ô∏è Apenas se rel√≥gios est√£o sincronizados (NTP)

**Problemas:**
- ‚ùå Clock skew entre clientes
- ‚ùå Timezones diferentes
- ‚ùå Rel√≥gios desajustados

**Recomenda√ß√£o:** Use outros m√©todos se poss√≠vel!

---

### 6Ô∏è‚É£ Desduplica√ß√£o Content-Based

**Conceito**: Calcula hash (SHA-256) do conte√∫do completo. Opera√ß√µes com mesmo hash s√£o duplicatas.

**Endpoints:**
- `GET /api/contentbased/operations` - Listar opera√ß√µes
- `POST /api/contentbased/event` - Processar evento
- `POST /api/contentbased/compute-hash` - Calcular hash
- `GET /api/contentbased/demo/hash-sensitivity` - Demo de sensibilidade

**Como Testar:**

```bash
# 1. Processar evento - SUCESSO
curl -X POST https://localhost:5001/api/contentbased/event \
  -H "Content-Type: application/json" \
  -d '{
    "eventType": "UserCreated",
    "userId": "user-123",
    "data": "Jo√£o Silva"
  }'

# 2. Enviar EXATAMENTE o mesmo conte√∫do - DUPLICATA DETECTADA
curl -X POST https://localhost:5001/api/contentbased/event \
  -H "Content-Type: application/json" \
  -d '{
    "eventType": "UserCreated",
    "userId": "user-123",
    "data": "Jo√£o Silva"
  }'

# Resposta: 409 Conflict - evento duplicado

# 3. Mudar 1 caractere - PROCESSADO (hash diferente)
curl -X POST https://localhost:5001/api/contentbased/event \
  -H "Content-Type: application/json" \
  -d '{
    "eventType": "UserCreated",
    "userId": "user-124",
    "data": "Jo√£o Silva"
  }'
```

**Quando Usar:**
- ‚úÖ Message Queues (RabbitMQ, Kafka, SQS)
- ‚úÖ Event Sourcing
- ‚úÖ Webhooks
- ‚úÖ Sistemas de eventos distribu√≠dos

**Vantagens:**
- N√£o precisa de chave gerada pelo cliente
- N√£o depende de timestamps
- Detecta duplicatas exatas automaticamente
- Ideal para mensageria!

---

## üîÑ Mock de Mensageria (Consumer)

A API inclui um **mock de sistema de mensageria** com Producer e Consumer.

### Arquitetura

```
Producer (API) ‚Üí Queue ‚Üí Consumer (Background Service) ‚Üí Deduplication
```

### Endpoints

- `POST /api/messagequeue/publish` - Publicar evento (Producer)
- `POST /api/messagequeue/publish-batch` - Publicar lote com duplicatas
- `GET /api/messagequeue/processing-history` - Hist√≥rico do Consumer
- `GET /api/messagequeue/consumer/status` - Status do Consumer
- `POST /api/messagequeue/demo/full-flow` - Demo completo

### Como Funciona

1. **Producer**: Voc√™ publica eventos via API
2. **Queue**: Eventos ficam em uma fila em mem√≥ria (Channel)
3. **Consumer**: Background Service processa eventos automaticamente
4. **Deduplication**: Usa Content-Based (hash SHA-256) para detectar duplicatas

### Teste Completo

```bash
# 1. Verificar status do Consumer
curl https://localhost:5001/api/messagequeue/consumer/status

# 2. Publicar evento
curl -X POST https://localhost:5001/api/messagequeue/publish \
  -H "Content-Type: application/json" \
  -d '{
    "eventType": "OrderCreated",
    "payload": "{\"orderId\":\"order-123\",\"amount\":500}"
  }'

# 3. Publicar o MESMO evento (duplicata)
curl -X POST https://localhost:5001/api/messagequeue/publish \
  -H "Content-Type: application/json" \
  -d '{
    "eventType": "OrderCreated",
    "payload": "{\"orderId\":\"order-123\",\"amount\":500}"
  }'

# 4. Aguardar processamento (alguns segundos)

# 5. Ver hist√≥rico - Consumer detectou a duplicata!
curl https://localhost:5001/api/messagequeue/processing-history
```

**Resultado Esperado:**
```json
{
  "summary": {
    "totalProcessed": 2,
    "successful": 1,
    "duplicates": 1,
    "failed": 0
  },
  "history": [
    {
      "eventId": "...",
      "success": true,
      "wasDuplicate": false,
      "message": "Evento processado com sucesso"
    },
    {
      "eventId": "...",
      "success": false,
      "wasDuplicate": true,
      "message": "Evento duplicado! J√° processado em ..."
    }
  ]
}
```

### Demo Autom√°tico

```bash
# Publicar 3 eventos (1 original + 2 duplicatas)
curl -X POST https://localhost:5001/api/messagequeue/demo/full-flow
```

Aguarde alguns segundos e verifique o hist√≥rico. O Consumer ter√°:
- ‚úÖ Processado o primeiro evento
- üö´ Detectado e ignorado as 2 duplicatas

---

## üìä Compara√ß√£o dos Padr√µes

| Padr√£o | Gera√ß√£o | Vantagens | Desvantagens | Caso de Uso |
|--------|---------|-----------|--------------|-------------|
| **Idempotency Key** | Cliente | Simples, confi√°vel | Cliente precisa gerar chave | Pagamentos, Pedidos |
| **Natural** | N/A | Sem c√≥digo extra | S√≥ PUT/DELETE | REST APIs padr√£o |
| **Version-Based** | Servidor | Detecta conflitos | Precisa versionar recursos | Optimistic Locking |
| **Token-Based** | Servidor | Previne replay | Token expira | Formul√°rios sens√≠veis |
| **Timestamp-Based** | Cliente | Ordem temporal | Clock skew! ‚ö†Ô∏è | IoT (com NTP) |
| **Content-Based** | Autom√°tico | Sem chave, sem timestamp | CPU para hash | Mensageria, Eventos |

---

## üéì Exerc√≠cios para Alunos

### Exerc√≠cio 1: Idempotency Key
1. Gere um UUID: `uuidgen` (Linux/Mac) ou online
2. Fa√ßa 3 requisi√ß√µes de pagamento com o MESMO UUID
3. Verifique que apenas 1 foi processado

### Exerc√≠cio 2: Optimistic Locking
1. GET um recurso e note a vers√£o
2. Simule 2 clientes atualizando simultaneamente
3. Um ter√° conflito - como resolver?

### Exerc√≠cio 3: Token-Based
1. Gere um token
2. Tente usar em 2 pagamentos
3. O que acontece? Por qu√™?

### Exerc√≠cio 4: Clock Skew
1. Use o endpoint `/api/timestampbased/demo/clock-skew`
2. Analise os resultados
3. Por que timestamp no futuro √© aceito?

### Exerc√≠cio 5: Mensageria
1. Publique um evento 5 vezes (mesmo conte√∫do)
2. Verifique o hist√≥rico
3. Quantos foram processados? Quantos duplicados?

### Exerc√≠cio 6: Hash Sensitivity
1. Use `/api/contentbased/demo/hash-sensitivity`
2. Note como 1 espa√ßo muda o hash completamente
3. Por que isso √© importante?

---

## üèóÔ∏è Arquitetura

```
webapi/
‚îú‚îÄ‚îÄ Controllers/          # Endpoints por padr√£o
‚îÇ   ‚îú‚îÄ‚îÄ IdempotencyKeyController.cs
‚îÇ   ‚îú‚îÄ‚îÄ NaturalIdempotencyController.cs
‚îÇ   ‚îú‚îÄ‚îÄ VersionBasedController.cs
‚îÇ   ‚îú‚îÄ‚îÄ TokenBasedController.cs
‚îÇ   ‚îú‚îÄ‚îÄ TimestampBasedController.cs
‚îÇ   ‚îú‚îÄ‚îÄ ContentBasedController.cs
‚îÇ   ‚îî‚îÄ‚îÄ MessageQueueController.cs
‚îú‚îÄ‚îÄ Models/               # DTOs e entidades
‚îÇ   ‚îú‚îÄ‚îÄ IdempotencyKey.cs
‚îÇ   ‚îú‚îÄ‚îÄ NaturalIdempotency.cs
‚îÇ   ‚îú‚îÄ‚îÄ ResourceVersion.cs
‚îÇ   ‚îú‚îÄ‚îÄ IdempotencyToken.cs
‚îÇ   ‚îú‚îÄ‚îÄ TimestampDeduplication.cs
‚îÇ   ‚îú‚îÄ‚îÄ ContentBasedDeduplication.cs
‚îÇ   ‚îî‚îÄ‚îÄ MessageQueueEvent.cs
‚îú‚îÄ‚îÄ Services/             # L√≥gica de neg√≥cio
‚îÇ   ‚îú‚îÄ‚îÄ IdempotencyKeyService.cs
‚îÇ   ‚îú‚îÄ‚îÄ NaturalIdempotencyService.cs
‚îÇ   ‚îú‚îÄ‚îÄ VersionBasedIdempotencyService.cs
‚îÇ   ‚îú‚îÄ‚îÄ TokenBasedIdempotencyService.cs
‚îÇ   ‚îú‚îÄ‚îÄ TimestampDeduplicationService.cs
‚îÇ   ‚îú‚îÄ‚îÄ ContentBasedDeduplicationService.cs
‚îÇ   ‚îú‚îÄ‚îÄ MessageQueueService.cs
‚îÇ   ‚îî‚îÄ‚îÄ MessageConsumerBackgroundService.cs
‚îî‚îÄ‚îÄ Program.cs            # Configura√ß√£o
```

---

## üîß Tecnologias

- **ASP.NET Core 8.0** - Framework web
- **Swagger/OpenAPI** - Documenta√ß√£o interativa
- **System.Threading.Channels** - Fila em mem√≥ria
- **SHA-256** - Hash criptogr√°fico
- **Background Services** - Consumer ass√≠ncrono

---

## üìù Notas Importantes

### Armazenamento em Mem√≥ria
‚ö†Ô∏è Esta √© uma aplica√ß√£o **educacional**. Em produ√ß√£o:
- Use Redis, Memcached ou banco de dados
- Implemente TTL (Time-To-Live) para chaves
- Considere persist√™ncia

### Clock Skew
‚ö†Ô∏è Timestamp-Based tem problemas conhecidos:
- Use NTP para sincronizar rel√≥gios
- Prefira outros m√©todos quando poss√≠vel
- Adicione margem de toler√¢ncia (¬± segundos)

### Performance
- Hash SHA-256 √© r√°pido mas usa CPU
- Armazenamento cresce com o tempo
- Implemente cleanup/garbage collection